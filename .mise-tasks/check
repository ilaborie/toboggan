#!/usr/bin/env bash
#MISE description="Run comprehensive pre-push checks: format, lint, and test"

set -eux

# Check formatting
cargo +nightly fmt --all --check

# Check no lint warning
cargo clippy --all-targets --all-features -- -D warnings

# Run tests
cargo nextest run

# Run doc tests
cargo test --doc

# Check toboggan-web with Biome
echo "Checking toboggan-web with Biome..."
cd toboggan-web && npm run check && cd ..

# Check Swift code with SwiftLint
if command -v swiftlint >/dev/null 2>&1; then
    echo "Checking Swift code with SwiftLint..."
    if [ -d "toboggan-ios/TobogganApp" ]; then
        if swiftlint lint toboggan-ios/TobogganApp --config .swiftlint.yml 2>/dev/null; then
            echo "SwiftLint check completed successfully"
        else
            echo "SwiftLint check failed or SourceKit unavailable, skipping Swift linting"
            echo "Note: This may happen in CI environments or when Xcode tools are not properly configured"
        fi
    else
        echo "No Swift code found in toboggan-ios/TobogganApp, skipping SwiftLint check"
    fi
else
    echo "SwiftLint not found, skipping Swift linting (install with: mise install swiftlint)"
fi

