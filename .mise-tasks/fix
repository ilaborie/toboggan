#!/usr/bin/env bash
#MISE description="Auto-format code and apply clippy suggested fixes"

set -eux

# Format
cargo +nightly fmt

# Fix lint
cargo fix --allow-dirty --allow-staged

# Fix toboggan-web with Biome
echo "Fixing toboggan-web with Biome..."
cd toboggan-web && npm run check:fix && cd ..

# Fix Swift code with SwiftLint
if command -v swiftlint >/dev/null 2>&1; then
    echo "Auto-fixing Swift code with SwiftLint..."
    if [ -d "toboggan-ios/TobogganApp" ]; then
        if swiftlint --fix toboggan-ios/TobogganApp --config .swiftlint.yml 2>/dev/null; then
            echo "SwiftLint auto-fix completed successfully"
        else
            echo "SwiftLint auto-fix failed or SourceKit unavailable, skipping Swift auto-fix"
            echo "Note: This may happen in CI environments or when Xcode tools are not properly configured"
        fi
    else
        echo "No Swift code found in toboggan-ios/TobogganApp, skipping SwiftLint fix"
    fi
else
    echo "SwiftLint not found, skipping Swift auto-fix (install with: mise install swiftlint)"
fi
